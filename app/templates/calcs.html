{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% block content %}


<main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Calculator </h1>
    </div>

    <p> Please select an account type:</p>
    <button type="button" class="btn btn-primary" id="formButton">Capital Account</button>

    <button type="button" class="btn btn-primary" id="formButton2">Operating Account</button>

    <br><br>
    
    <div class="form-row">
        <form action="" method="post" novalidate id="calcForm" class="form ">
            {{ form.hidden_tag() }}
                        <div class="form-group" id="month" style="width: 100%">
                    {{ wtf.form_field(form.month, class='form-control', placeholder='eg. dec') }}
                    {% for error in form.month.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
		{% if error["month"] == True %}
                    <span style="color: red;">There are errors with the months, Please check again</span>
                {% endif %}
                
                <p class="font-weight-light">This is the starting month of the calculation. </p>
            </div>

            <div class="form-group" id="year" style="width: 100%">
                    {{ wtf.form_field(form.year, class='form-control', placeholder='e.g 2018') }}
                    {% for error in form.year.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
                
		{% if error["year"] == True %}
                    <span style="color: red;">There are errors with the years, Please check again</span>
                {% endif %}

                <p class="font-weight-light">This is the starting year of the calculation. </p>
            </div>

            <div class="form-group" id="fundValue" style="width: 100%">
                     {{ wtf.form_field(form.fundvalue, class='form-control', placeholder='e.g 10000000 (no commas or $)') }}
                
                     {% for error in form.fundvalue.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}

            <p class="font-weight-light">This is the initial opening balance of the fund.</p>
            </div>
            
            <div class="form-group" id="interestClass" style="width: 100%">
                
                    {{ wtf.form_field(form.interestClass, class='form-control', placeholder='e.g E') }}
                    {% for error in form.interestClass.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}

                    <p class="font-weight-light"> 
                        Interest Classes:
                        - Long Term Pool: E, F,G.
                        - Medium Term Pool: H
                        - Short Term Pool: A, N, Q
                        - Cash Pool: S</p>
            </div>

            <div class="form-group" id="donation" style="width: 100%">
                
                     {{ wtf.form_field(form.donation, class='form-control', placeholder='e.g jun-2020-1000000,jul-2020-0') }}
                     {% for error in form.donation.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
                
		{% if error["donation"] == True %}
                    <p><span style="color: red;">There are errors with the Donation Field, Please check again</span></p>
                {% endif %}

                <p class="font-weight-light">Money that is received from donations after the initial contribution at fund
                    commencement. </p>
            </div>

            <div class="form-group" id="spending" style="width: 100%">
                    {{ wtf.form_field(form.spending, class='form-control', placeholder='e.g 0') }}
                    {% for error in form.spending.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
                
		{% if error["spending"] == True %}
                    <p><span style="color: red;">There are errors with the Spending Field, Please check again</span></p>
                {% endif %}

                <p class="font-weight-light">Spending profile of the funds over the duration of the timeframe.</p>

            </div>


            <div class="form-group" id="recap" style="width: 100%">
                
                    {{ wtf.form_field(form.recap, class='form-control', placeholder='e.g jun-2021-10000,jul-2021-0') }}
                     {% for error in form.recap.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
            
		{% if error["recap"] == True %}
                    <p><span style="color: red;">There are errors with the Recap Field, Please check again</span></p>
                {% endif %}

                <p class="font-weight-light">Amount to be recapitalised from the Operating Accounts to the Capital
                    Accounts.</p>
            </div>


            <div class="form-group" id="distribution" style="width: 100%">
            
                    {{ wtf.form_field(form.distribution, class='form-control', placeholder='e.g 0.05') }}
                    {% for error in form.distribution.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}

                    <p class="font-weight-light">This is the distribution rate of the fund. </p>

            </div>

            <div class="form-group" id="operatingDistribution" style="width: 100%">
                
                    {{ wtf.form_field(form.operatingDistribution, class='form-control', placeholder='e.g 0') }}
                    {% for error in form.operatingDistribution.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
                
		{% if error["operatingDistribution"] == True %}
                    <p><span style="color: red;">There are errors with the Operating Distribution Field, Please check again</span></p>
                {% endif %}
        
                <p class="font-weight-light">Capital distribution that Operating Accounts receives from the Capital Account
                    after the initial fund injection.</p>
            </div>


            <div class="form-group" id="additionalContribution" style="width: 100%">
                
                    {{ wtf.form_field(form.additionalContribution, class='form-control', placeholder='e.g 0') }}
                    {% for error in form.additionalContribution.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
                
		{% if error["additionalContribution"] == True %}
                <p><span style="color: red;">There are errors with the Additional Contribution Field, Please check again</span></p>
                {% endif %}
                <p class="font-weight-light">For certain classes of Operating Accounts that receive capital injections.

                    Additional contribution amounts can be added to the fund value.</p>
            </div>



            <div class="form-group" id="timeframe" style="width: 100%">
            
                    {{ wtf.form_field(form.timeframe, class='form-control', placeholder='e.g 12') }}
                     {% for error in form.timeframe.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}

                    <p class="font-weight-light">The time frame is the number of years from the starting month and year over
                        which you would like to complete the calculation.</p>
            </div>
			
			{% if current_user.is_authenticated %}
            <div class="form-group" style="width: 100%">
                
                    {{ form.savedata(size=32) }} {{ form.savedata.label }}<br> {% for error in form.savedata.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}

                    {{ wtf.form_field(form.nickname, class='form-control') }}
                     {% for error in form.nickname.errors %}
                    <span style="color: red;">[{{ error }}]</span> {% endfor %}
                
            </div>
			{% endif %}
            
            <div  style="width: 20%">
            <p>{{ form.submit(class="btn btn-primary btn-md btn-block") }}</p>
            {% if error == True %}
                <p><span style="color: red;">There are errors with the inputs, Please check again</span></p>
            {% endif %}
            </div>
			{% if current_user.is_anonymous %}
			<div class="form-group">
                <p>
					<a href="{{ url_for('signin') }}">Sign in to save your calculation.</a>
				</p>
            </div>
            {% endif %}
            <div style="width: 20%">
            <p>{{ form.expo(class="btn btn-primary btn-md btn-block") }}</p>
            </div>
        </form>
    </div>




    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Results </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group mr-2">
                <form action="" method="POST">
                    <!--<button type="submit" class="btn-sm btn-outline-secondary">Export</button>-->
                </form>
                <!--<form>
                    <<a href=# id=test><button type="submit" class="btn btn-sm btn-outline-secondary">Export</button></a>
                </form>-->
            </div>
        </div>
    </div>

    <p>Results are shown here after calculation.</p>

    {% if error == {} %}

    <div class="container">
        <div class="row">
                <canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas>
        </div>
    </div>

    <button type="button" class="btn btn-primary mb-2" id="YearButton">View Year Table</button>
    <button type="button" class="btn btn-primary mb-2" id="MonthButton">View Month Table</button>
    <button type="button" onclick="lineChart()" class="btn btn-primary mb-2" id="LineButton">View as Line Graph</button>
    <button type="button" onclick="barChart()" class="btn btn-primary mb-2" id="BarButton">View Bar Graph</button>

    <div class="table-responsive" id="yeartable">
        <table class="table table table-striped ">
            <thead>
                <tr class="bg-primary text-white">
                    <th scope="col">Year</th>
                    {% for year in range(timeframe|int +1) %}
                    
                    {% if (year * 12 ) in calc[0].keys() %}
                    <th scope="col">{{ years + year }} </th>
                    {% endif %}
                    {% endfor %}

                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Opening Balance</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    <th>{{ "${:,.2f}".format(calc[0][year]) }} </th>
                    {% endfor %}
                </tr>
                <tr>
                    <td>Interest Returns </td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[2].keys() %}
                    <th>{{ "${:,.2f}".format(calc[2][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <!---->
                {% if form.interestClass.data.lower() == 'e' or form.interestClass.data.lower() == 'f' or form.interestClass.data.lower() == 'g' %}
                <tr>
                    <td>Donations</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[3].keys() %}
                    <th>{{ "${:,.2f}".format(calc[3][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Recapitalization</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[4].keys() %}
                    <th>{{ "${:,.2f}".format(calc[4][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Capital Distribution</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[5].keys() %}
                    <th>{{ "${:,.2f}".format(calc[5][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% elif form.interestClass.data.lower() == 'a' %}
                <tr>
                    <td>Capital Distribution</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[3].keys() %}
                    <th>{{ "${:,.2f}".format(calc[3][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Spending</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[4].keys() %}
                    <th>{{ "${:,.2f}".format(calc[4][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Recapitalization</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[5].keys() %}
                    <th>{{ "${:,.2f}".format(calc[5][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% else %}
                <tr>
                    <td>Additonal Capital Contribution</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[3].keys() %}
                    <th>{{ "${:,.2f}".format(calc[3][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Spending</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    {% if year in calc[4].keys() %}
                    <th>{{ "${:,.2f}".format(calc[4][year]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endif %}
            
                <tr>
                    <td>Closing Balance</td>
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    <th>{{ "${:,.2f}".format(calc[1][year]) }} </th>
                    {% endfor %}
                </tr>

            </tbody>
        </table>
    </div>
    {% endif %}




    {% if error == {} %}
    <div class="table-responsive" id ="monthtable">
        <table class="table table table-striped ">
            <thead>
                <tr class="bg-primary text-white">
                    <th scope="col">Month</th>
                    {% for month in range((timeframe|int *12) + 1) %}
                    {% if (month) in calc[0].keys() %}
                    {%  set monthDict = {0 : "Jan",
                    1 : "Feb",
                    2 : "Mar",
                    3 : "Apr",
                    4 : "May",
                    5 : "Jun",
                    6 : "Jul",
                    7 : "Aug",
                    8 : "Sep",
                    9 : "Oct",
                    10 : "Nov",
                    11 : "Dec"} %}
                    <th scope="col">{{ monthDict[(months + month -1) % 12 ] }} {{ years + month//12}} </th>
                    {% endif %}
                    {% endfor %}

                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Opening Balance</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    <th>{{ "${:,.2f}".format(calc[0][month]) }} </th>
                    {% endfor %}
                </tr>
                <tr>
                    <td>Interest Returns </td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[2].keys() %}
                    <th>{{ "${:,.2f}".format(calc[2][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <!---->
                {% if form.interestClass.data.lower() == 'e' or form.interestClass.data.lower() == 'f' or form.interestClass.data.lower() == 'g' %}
                <tr>
                    <td>Donations</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[3].keys() %}
                    <th>{{ "${:,.2f}".format(calc[3][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Recapitalization</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[4].keys() %}
                    <th>{{ "${:,.2f}".format(calc[4][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Capital Distribution</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[5].keys() %}
                    <th>{{ "${:,.2f}".format(calc[5][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% elif form.interestClass.data.lower() == 'a' %}
                <tr>
                    <td>Capital Distribution</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[3].keys() %}
                    <th>{{ "${:,.2f}".format(calc[3][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Spending</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[4].keys() %}
                    <th>{{ "${:,.2f}".format(calc[4][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Recapitalization</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[5].keys() %}
                    <th>{{ "${:,.2f}".format(calc[5][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% else %}
                <tr>
                    <td>Additonal Capital Contribution</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if year in calc[3].keys() %}
                    <th>{{ "${:,.2f}".format(calc[3][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <td>Spending</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    {% if month in calc[4].keys() %}
                    <th>{{ "${:,.2f}".format(calc[4][month]) }} </th>
                    {% else %}
                    <th>$0.00</th>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endif %}
            
                <tr>
                    <td>Closing Balance</td>
                    {% for month in range((timeframe|int * 12) + 1) %}
                    <th>{{ "${:,.2f}".format(calc[1][month]) }} </th>
                    {% endfor %}
                </tr>

            </tbody>
        </table>
    </div>
    {% endif %}
</main>



<!-- Graphs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
<script>
    var canvas = document.getElementById("myChart");
    var monthdatalabels = [];
    var yeardatalabels = [
                    {% for year in range(timeframe|int +1) %}
                    "{{ years + year }}" ,
                    {% endfor %}];
    var yeardata = [ 
                    {% for year in range(decMonth,timeframe|int * 12 + 1, 12) %}
                    "{{ (calc[1][year]) }}" ,
                    {% endfor %}];
    var monthdata = [
                    {% for month in range((timeframe|int * 12) + 1) %}
                    "{{ (calc[1][month]) }}" ,
                    {% endfor %}];
    
    var ctx = canvas.getContext('2d');
    // We are only changing the chart type, so let's make that a global variable along with the chart object:
    var chartType = 'line';
    var mylineChart;
    var data = {
            labels: yeardatalabels,
            datasets: [{
                label: 'Closing Balances',
                data: yeardata,
                lineTension: 0,
                backgroundColor: 'transparent',
                borderColor: '#007bff',
                borderWidth: 4,
                pointBackgroundColor: '#007bff'
            }]
        };

    var options = {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: false
                    }
                }]
            },
            legend: {
                display: true,
            }
        };

    init();

    function init() {
    // Chart declaration:
        mylineChart = new Chart(ctx, {
            type: chartType,
            data: data,
            options: options
        });
    }

    function barChart() {
        mylineChart.destroy();
        this.chartType = 'bar';
        init();
    }

    function lineChart() {
        mylineChart.destroy();
        this.chartType = 'line';
        init();
    }

</script>

{% endblock %}
